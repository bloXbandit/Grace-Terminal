import{aD as S,aE as x,d as y,h as _,l as p}from"./index-y24F1-rU.js";import"./index-TjCxX7sJ.js";import{h as d}from"./http-D7M9oJmQ.js";import{e as v}from"./emitter-E5P-NQ8u.js";const c={async list(t="task",e=null){const n=`/api/conversation?${new URLSearchParams({mode_type:t,agent_id:e}).toString()}`;return await d.get(n)||{}},async create(t,e="task",i=null,n=null){return await d.post("/api/conversation",{content:t,mode_type:e,agent_id:i,model_id:n})||{}},async update(t,e=""){const i=`/api/conversation/${t}`;return await d.put(i,{title:e})||{}},async get(t){const e=`/api/conversation/${t}`;return await d.get(e)||{}},async remove(t){const e=`/api/conversation/${t}`;return await d.del(e)||{}},async query(t){return await d.post("/api/conversation/query",{query:t})||{}},async favorite(t){return await d.post("/api/conversation/favorite",{conversation_id:t})||{}},async unfavorite(t){return await d.post("/api/conversation/unfavorite",{conversation_id:t})||{}},async messageList(t){const e=`/api/message/list?conversation_id=${t}`;return await d.get(e)||{}},async stop(t){return await d.post("/api/agent/stop",{conversation_id:t})||{}}},l=[];for(let t=0;t<256;++t)l.push((t+256).toString(16).slice(1));function M(t,e=0){return(l[t[e+0]]+l[t[e+1]]+l[t[e+2]]+l[t[e+3]]+"-"+l[t[e+4]]+l[t[e+5]]+"-"+l[t[e+6]]+l[t[e+7]]+"-"+l[t[e+8]]+l[t[e+9]]+"-"+l[t[e+10]]+l[t[e+11]]+l[t[e+12]]+l[t[e+13]]+l[t[e+14]]+l[t[e+15]]).toLowerCase()}let f;const T=new Uint8Array(16);function k(){if(!f){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");f=crypto.getRandomValues.bind(crypto)}return f(T)}const j=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),g={randomUUID:j};function C(t,e,i){var s;if(g.randomUUID&&!t)return g.randomUUID();t=t||{};const n=t.random??((s=t.rng)==null?void 0:s.call(t))??k();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,M(n)}let m="running";function $(t,e){if(t.meta&&typeof t.meta=="string"&&(t.meta=JSON.parse(t.meta)),t.meta.action_type=="")return;if(!t.meta||!t.meta.action_type)return e.push(t);const{action_type:i}=t.meta;if(console.log("handleMessage",t),!(m=="stop"&&i!="question"&&i!="auto_reply"))switch(i){case"chat":return L(t,e);case"auto_reply":return m="running",U(t,e);case"plan":return D(t,e);case"question":return m="running",E(t,e);case"finish_summery":case"progress":case"coding":return b(t,e);case"stop":return w(t,e);case"error":return w(t,e);case"finish":return;case"task":return R(t,e);default:return N(t,e)}}function w(t,e){var i;e.push(t),console.log("handleStop",e);for(let n=e.length-1;n>=0;n--)((i=e[n].meta)==null?void 0:i.action_type)==="update_status"&&e.splice(n,1);e.forEach(n=>{var s;return((s=n.meta)==null?void 0:s.action_type)==="plan"&&Array.isArray(n.meta.json)&&n.meta.json.forEach(a=>{a.status=="running"&&(a.status="success");let o=a.actions;(o==null?void 0:o.length)>0&&o.forEach(r=>{r.status=="running"&&(r.status="success")})}),n})}function b(t,e){let i=t.meta.json;for(let n=0;n<i.length;n++){const s=i[n];s.id=C()}e.push(t)}function B(t){//!message.is_temp && message.meta.action_type !== "update_status" 删除
var e;for(let i=t.length-1;i>=0;i--){const n=t[i];((e=n==null?void 0:n.meta)==null?void 0:e.action_type)=="update_status"&&t.splice(i,1)}}function D(t,e){B(e),console.log("plan",t),t.meta&&t.meta.json&&Array.isArray(t.meta.json)&&(t.meta.json.forEach(i=>{i.is_collapse=!0}),t.meta.json.length>0&&(t.meta.json[0].status="running")),e.push(t)}function U(t,e){e.push(t),e.push({content:S.global.t("lemon.message.botInitialPlan"),role:"assistant",is_temp:!0,meta:{action_type:"update_status"}})}function L(t,e){console.log("handleChatMessage",t),e.push(t)}function E(t,e){console.log("handleQuestion",t);let i=e.findLastIndex(n=>n.role==="user"&&n.is_temp);i!==-1?(e[i]=t,e[i].files=t.meta.json):e.push(t)}function R(t,e){const i=t.meta.task_id;let n=e.findLastIndex(o=>o.meta&&o.meta.action_type==="plan"),s=e[n],a=s.meta.json.findIndex(o=>o.id===i);if(a!==-1){s.meta.json[a].status=t.meta.json.status||t.status,s.meta.json[a].meta=t.meta;let o=t.meta.json.status||t.status;if(o==="failure"){let r=s.meta.json[a].actions||[];r=r.filter(u=>u.status!=="running"),s.meta.json[a].actions=r}(o==="success"||o==="completed")&&s.meta.json[a+1]&&(s.meta.json[a+1].status="running")}}function N(t,e){const i=t.meta.task_id,n=t.uuid;t.meta.action_type==="terminal_run"&&(t.content=[t.content]);let s=e.findLastIndex(h=>h.meta&&h.meta.action_type==="plan"),a=e[s],o=a.meta.json.findIndex(h=>h.id===i);o===-1&&(o=a.meta.json.findIndex(h=>h.status==="running"),o===-1&&(o=Math.max(0,a.meta.json.length-1))),a.meta.json[o].actions||(a.meta.json[o].actions=[]);let r=a.meta.json[o].actions,u=r.findIndex(h=>h.uuid===n);u!==-1?(r[u].status=t.status,r[u].meta=t.meta,console.log("message.action_type",t.meta.action_type),t.meta.action_type==="terminal_run"&&(r[u].content=[r[u].content[0],t.content[0]]),t.meta.action_type==="mcp_tool"&&(r[u].meta.content=t.content)):r.push(t)}const I={handleMessage:$},A=void 0,W=x("chat",{state:()=>({list:[],chat:{},messages:[],events:[],agent:{},status:"done",conversationId:null,socket:null,baseUrl:A,commands:[],isScrolledToBottom:!0,updateTitle:!0,userMessageCount:0,stopReplay:!1,replayStatus:"done",mode:"task",mode_editor:!1,model_id:"",chatInfo:{pid:-1,msgList:[],cursorKey:""}}),actions:{async init(t="task"){this.mode=t,this.mode=="chat"&&(this.agent={}),console.log("init",t);let i=await c.list(t,this.agent.id)||[];i.sort((n,s)=>new Date(s.update_at)-new Date(n.update_at)),this.list=i},async selectFirst(){this.mode=="task"&&this.list.length>0?(console.log(" 默认选择第一个 selectFirst"),this.conversationId=this.list[0].conversation_id,this.clearMessages(),this.chat=this.list[0],this.initConversation(this.conversationId),console.log("this.chat",this.chat)):(this.clearMessages(),this.chat={},this.conversationId=null)},async handleStop(){this.mode_editor?await c.stopCoding(this.conversationId):this.mode==="task"?await c.stop(this.conversationId):(this.chatInfo.cursorKey="",await c.stopChat(this.conversationId)),this.list.find(t=>t.conversation_id===this.conversationId).status="done",this.chat.status="done",this.status="done"},clearMessages(){this.messages=[],this.isScrolledToBottom=!0,this.status=="done",this.chatInfo.pid=-1},clearAgent(){this.agent={},this.list=[],console.log("clearAgent",this.agent)},async initConversation(t){console.log("initConversation"),await this.resetChatInfo();let e=await c.messageList(t);if(this.messages=[],this.mode==="task"){e.forEach(n=>{n.meta&&typeof n.meta=="string"&&(n.meta=JSON.parse(n.meta));const{action_type:s}=n.meta;if(s=="error"||s=="stop"){let a=n.conversation_id,o=this.list.find(r=>r.conversation_id==a);o&&(o.status="done")}I.handleMessage(n,this.messages)});const i=e[e.length-1];if(i&&i.meta){const{action_type:n}=i.meta;if(n==="error"||n==="stop"){let s=i.conversation_id,a=this.list.find(o=>o.conversation_id==s);a&&(a.status="done")}}}else this.mode==="chat"&&(this.chatInfo.msgList=e);this.scrollToBottom()},async playback(t,e=0){this.stopReplay=!1,this.replayStatus="running",this.messages=[];const i=await c.get(t);this.chat=i;let n=await c.messageList(t);for(let s of n){let a=100;this.stopReplay||(await new Promise(o=>setTimeout(o,e)),a=0),I.handleMessage(s,this.messages),setTimeout(()=>{const o=window.innerWidth<=768;o||v.emit("preview",{message:s});let r=JSON.parse(JSON.stringify(s.meta)),u=(r==null?void 0:r.json[0])||{};console.log("meta.action_type",r.action_type),r.action_type=="finish_summery"&&u&&!o&&v.emit("fullPreviewVisable",u)},a),this.isScrolledToBottom=!0,this.scrollToBottom(0)}this.replayStatus="done"},async toResult(){this.replayStatus="done",this.stopReplay=!0},async autoTitle(){if(this.updateTitle&&this.userMessageCount>=2)try{const t=await c.update(this.conversationId,"");console.log("update_res",t);const e=await c.get(this.conversationId);if(e&&e.title){this.chat.title=e.title,this.chat.status="running";const i=this.list.find(n=>n.conversation_id===this.conversationId);i&&(i.title=e.title,i.status="running"),console.log("this.list",this.list)}this.updateTitle=!1,this.status="running"}catch(t){console.error("autoTitle error:",t),this.updateTitle=!1}},incrementUserMessageCount(){this.userMessageCount++,console.log("User message count:",this.userMessageCount),this.userMessageCount===2&&this.autoTitle()},async updateConversationTitle(t){const e=await c.update(this.conversationId,t);this.chat.title=t;const i=this.list.find(n=>n.conversation_id===this.conversationId);i&&(i.title=e.title)},async updateConversationTitleById(t,e){const i=await c.update(e,t),n=this.list.find(s=>s.conversation_id===e);n&&(n.title=i.title),e===this.conversationId&&(this.chat.title=t)},async updateConversationVisibility(t){const e=await c.updateVisibility(this.conversationId,t);this.chat.is_public=t;const i=this.list.find(n=>n.conversation_id===this.conversationId);return i&&(i.is_public=t),e},async updateConversationVisibilityById(t,e){const i=await c.updateVisibility(e,t),n=this.list.find(s=>s.conversation_id===e);return n&&(n.is_public=t),e===this.conversationId&&(this.chat.is_public=t),i},onMessageEvent(t){const{source:e,message:i}=t},async createConversation(t,e="task"){console.log("createConversation",this.model_id),this.messages=[],await this.resetChatInfo(),this.updateTitle=!0;const i=await c.create(t,e,this.agent.id,this.model_id);return this.chat=i,this.conversationId=i.conversation_id,e=="task"?this.init():this.init("chat"),this.autoTitle(),i},async resetChatInfo(){this.chatInfo={pid:-1,msgList:[]},this.userMessageCount=0},sendMessage(t){},handleInitMessage(t,e=[],i="",n=""){console.log("handleInitMessage",t),this.mode_editor=!1;let s={json:e,action_type:"question"};i&&n&&(this.mode_editor=!0,s.json={files:e,screenshot:i,filepath:n});const a={content:t,timestamp:new Date().getTime(),meta:s,role:"user",is_temp:!0};this.messages.push(a);const o={content:"",role:"assistant",timestamp:new Date().getTime(),is_temp:!0};this.messages.push(o),this.isScrolledToBottom=!0,this.scrollToBottom()},async removeConversation(t){const e=await c.remove(t);let i=this.list.findIndex(n=>n.conversation_id===t);return i!==-1&&this.list.splice(i,1),e},scrollToBottom(t=500){setTimeout(()=>{console.log("scrollToBottom",this.isScrolledToBottom);const e=document.querySelector(".chat-messages");this.isScrolledToBottom&&(e.scrollTop=e.scrollHeight-e.clientHeight)},t)},async favorite(){await c.favorite(this.conversationId),this.chat.is_favorite=!0},async unfavorite(){await c.unfavorite(this.conversationId),this.chat.is_favorite=!1},async convertToTree(t){console.log("初始化tree",t);const e=new Map;t.forEach(n=>{const s=JSON.parse(n.meta);console.log("meta",s),e.set(n.id,{id:n.id,pid:s.pid,role:n.role,content:n.content,children:[]})});const i=[];return e.forEach(n=>{if(n.pid==="-1")i.push(n);else{const s=e.get(Number(n.pid));s&&s.children.push(n)}}),i.sort((n,s)=>n.id-s.id),i}},persist:!0}),V={xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-x h-5 w-5 text-[var(--icon-tertiary)]"};function F(t,e){return _(),y("svg",V,e[0]||(e[0]=[p("path",{d:"M18 6 6 18M6 6l12 12"},null,-1)]))}const z={render:F},G=t=>{const e=new Date(t),i=new Date,n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return isNaN(n)?"":n===i.getFullYear()?`${s}/${a}`:`${n}/${s}/${a}`},X=t=>{const e=new Date(t),i=new Date,n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),u=String(e.getSeconds()).padStart(2,"0");return isNaN(n)?"":n===i.getFullYear()?`${s}/${a} ${o}:${r}:${u}`:`${n}/${s}/${a} ${o}:${r}:${u}`},q={xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",fill:"none",stroke:"#535350","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-ellipsis text-[var(--icon-secondary)]",viewBox:"0 0 24 24"};function H(t,e){return _(),y("svg",q,e[0]||(e[0]=[p("circle",{cx:"12",cy:"12",r:"1"},null,-1),p("circle",{cx:"19",cy:"12",r:"1"},null,-1),p("circle",{cx:"5",cy:"12",r:"1"},null,-1)]))}const Z={render:H},J={xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"none",stroke:"#535350","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",class:"lucide lucide-pencil",viewBox:"0 0 24 24"};function O(t,e){return _(),y("svg",J,e[0]||(e[0]=[p("path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497zM15 5l4 4"},null,-1)]))}const tt={render:O};export{Z as M,X as a,z as c,tt as e,G as f,I as m,c as s,W as u,C as v};
