import{s as X}from"./auth-Drg3eDmO.js";import{s as v}from"./membership-B0vPv27N.js";import{p as Z,u as ee,a2 as te,a3 as se,r as l,c as ae,o as ne,f as g,g as oe,a4 as Y,d as c,l as t,e as u,j as O,t as n,v as o,F as T,D as E,w as b,C as ie,a1 as le,h as r,a5 as ce,a6 as re}from"./index-fenXWili.js";import{S as de,W as pe}from"./wechatpay-DI21vhe3.js";import"./http-DmdJyNsP.js";const ue={class:"usage"},me={class:"member-info"},_e={style:{display:"flex","align-items":"center","justify-content":"space-between"}},ve={class:"plan-name"},ye={key:0,class:"expiration-date"},he={style:{gap:"12px",display:"flex"}},fe={class:"points-details"},ge={class:"points-details-text-container"},be={class:"points-details-text"},we={class:"points-details-total"},Pe={class:"points-details-accounts"},xe={class:"points-accounts"},ke={class:"points-accounts"},Ce={key:0,class:"recharge-products"},Se={class:"product-title"},De={class:"product-info"},Te={style:{"margin-top":"8px"}},Ae=["loading","onClick"],Ie={key:1},Me={style:{"text-align":"center",display:"flex","flex-direction":"column","align-items":"center"}},$e={style:{display:"inline-block"}},Ne={style:{"margin-top":"12px"}},Ue={style:{display:"flex","flex-direction":"column",gap:"16px",padding:"12px 4px"}},Re={class:"payment-content"},Ye={class:"payment-title"},Oe={class:"payment-description"},Ee={class:"payment-content"},He={class:"payment-title"},Le={class:"payment-description"},ze={__name:"usage",setup(Fe){const{t:s}=ee(),A=oe(),H=te(),{user:Be,membership:m,points:w}=se(H),L=l(!0),z=ae(()=>L.value?"$":"¥");async function F(){let e=await X.getUserInfo();m.value=e.membership,w.value=e.points}const y=l(1),P=l(5),I=l(0),M=l([]),h=l(!1),$=l(""),f=l(!1),x=l(null),k=l(null),_=l(!1),C=l(!1),S=l([]);ne(()=>{F(),U(),window.electronAPI&&(window.electronAPI.on("stripe-payment-success",({orderId:e,amount:a,currency:d,status:p})=>{console.log("stripe-payment-success",e,a,d,p),p==="paid"?(g.success(s("member.paySuccess")),A.push({name:"app"})):g.error(s("member.payFailed"))}),window.electronAPI.on("stripe-payment-cancel",()=>{g.error(s("member.payCancel"))}))});function B(e){switch(e){case"FREE":return s("member.pointsType.free");case"MONTHLY":return s("member.pointsType.monthly");case"PURCHASED_ADDON":return s("member.pointsType.purchasedAddon");case"GIFTED_ADDON":return s("member.pointsType.giftedAddon");case"FEEDBACK_ADDON":return s("member.pointsType.feedbackAddon")}}const V=async e=>{f.value=!0,x.value=e},N=async e=>{if(f.value=!1,_.value=!0,e==="stripe"){let d=await v.createStripePointPurchaseOrder(x.value.id,"web");window.location.href=d.url,_.value=!1}else{let a=await v.createPointPurchaseOrder(x.value.id);a&&a.code_url?(_.value=!1,$.value=a.code_url,h.value=!0,j(a.order_sn)):_.value=!1,console.log(a)}},j=async e=>{let d=0;k.value=setInterval(async()=>{d++;const p=await v.checkOrderStatus(e);(p==null?void 0:p.status)==="paid"&&(clearInterval(k.value),h.value=!1,g.success(s("member.paymentSuccess")),q(),console.log("支付成功")),d>=20&&(clearInterval(k.value),console.warn("支付超时，请重新下单"))},3e3)},q=()=>{window.location.reload()},U=async()=>{const e=await v.getPointsTransactionList({page:y.value,pageSize:P.value});console.log(e),I.value=e.pagination.total,M.value=e.list},W=e=>{y.value=e.current,P.value=e.pageSize,U()},G=()=>{A.push({name:"pricing"})},K=async()=>{let e=await v.getRechargeProductList();S.value=e||[],C.value=!0},Q=[{title:s("member.table.details"),dataIndex:"description",key:"description"},{title:s("member.table.time"),dataIndex:"created_at",key:"created_at",customRender:({text:e})=>Y(e).format("YYYY-MM-DD HH:mm")},{title:s("member.table.pointsChange"),key:"amount",customRender:({record:e})=>`${e.type==="credit"?"+":e.type==="debit"?"-":""}${e.amount}`}];return(e,a)=>{var R;const d=ce,p=ie,D=le,J=re;return r(),c(T,null,[t("div",ue,[t("div",me,[t("div",_e,[t("div",null,[t("div",ve,n(((R=o(m))==null?void 0:R.planName)||o(s)("member.freePlan")),1),o(m)?(r(),c("div",ye,n(o(s)("member.expirationDate"))+n(o(Y)(o(m).endDate).format("YYYY-MM-DD HH:mm")),1)):O("",!0)]),t("div",he,[t("button",{onClick:G,class:"upgrade"},n(o(s)("member.upgrade")),1),o(m)?(r(),c("button",{key:0,onClick:K,class:"upgrade"},n(o(s)("member.purchasePoints")),1)):O("",!0)])]),t("div",fe,[t("div",ge,[t("div",be,n(o(s)("member.points")),1),t("div",we,n(o(w).total),1)]),t("div",null,[(r(!0),c(T,null,E(o(w).accounts,i=>(r(),c("div",Pe,[t("div",xe,n(B(i.type)),1),t("div",ke,n(i.balance),1)]))),256))])])]),u(p,{title:o(s)("member.pointsUsageHistory")},{default:b(()=>[u(d,{columns:Q,onChange:W,"data-source":M.value,"row-key":"id",pagination:{current:y.value,pageSize:P.value,page:y.value,total:I.value}},null,8,["data-source","pagination"])]),_:1},8,["title"])]),u(D,{open:C.value,"onUpdate:open":a[0]||(a[0]=i=>C.value=i),title:o(s)("member.purchasePoints"),footer:null,width:"800px",class:"recharge-modal",centered:""},{default:b(()=>[S.value.length?(r(),c("div",Ce,[(r(!0),c(T,null,E(S.value,i=>(r(),c("div",{key:i.id,class:"product-card"},[t("div",Se,n(i.product_name),1),t("div",De,[t("p",Te,n(z.value)+" "+n(i.amount),1),t("p",null,n(i.points_awarded)+n(o(s)("member.pointsUnit")),1)]),t("button",{size:"small",loading:_.value,onClick:Ve=>V(i)},n(o(s)("member.buyNow")),9,Ae)]))),128))])):(r(),c("div",Ie,n(o(s)("member.noPackagesAvailable")),1))]),_:1},8,["open","title"]),u(D,{open:h.value,"onUpdate:open":a[1]||(a[1]=i=>h.value=i),title:o(s)("member.wechatScanToPay"),centered:"",footer:null},{default:b(()=>[t("div",Me,[t("div",$e,[u(J,{value:$.value,size:200},null,8,["value"])]),t("p",Ne,n(o(s)("member.wechatScanPrompt")),1)])]),_:1},8,["open","title"]),u(D,{open:f.value,"onUpdate:open":a[4]||(a[4]=i=>f.value=i),footer:null,centered:"",width:"480",title:e.$t("member.selectPaymentMethod")},{default:b(()=>[t("div",Ue,[t("div",{class:"payment-option",onClick:a[2]||(a[2]=i=>N("stripe"))},[u(o(de)),t("div",Re,[t("div",Ye,n(e.$t("payment.stripe.title")),1),t("div",Oe,n(e.$t("payment.stripe.description")),1)])]),t("div",{class:"payment-option",onClick:a[3]||(a[3]=i=>N("wechat"))},[u(o(pe)),t("div",Ee,[t("div",He,n(e.$t("payment.wechat.title")),1),t("div",Le,n(e.$t("payment.wechat.description")),1)])])])]),_:1},8,["open","title"])],64)}}},Qe=Z(ze,[["__scopeId","data-v-4008df5d"]]);export{Qe as default};
